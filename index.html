<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skinpack Studio Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --app-green: #03C75A;
            --app-bg: #ffffff;
            --app-gray: #f4f4f4;
            --text-dark: #1e1e1e;
            --text-light: #8e8e93;
            --border: #e5e5ea;
            --danger: #ff3b30;
            --vh: 100vh;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--app-bg);
            color: var(--text-dark);
            overflow: hidden;
            height: 100vh; 
            height: var(--vh);
            position: relative;
        }

        .input-error {
            border: 2px solid var(--danger) !important;
            background-color: #fff5f5 !important;
        }

        button:disabled {
            background-color: #cccccc !important;
            color: #888888 !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: none; flex-direction: column; z-index: 10;
        }
        .screen.active { display: flex; }

        /* App Bar */
        .app-bar {
            height: 64px; padding: 0 16px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); flex-shrink: 0;
            background: white; position: relative;
        }
        .app-bar h2 { 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            font-size: 14px; font-weight: 800; letter-spacing: 1px; 
            text-transform: uppercase; white-space: nowrap; margin: 0;
        }
        .text-btn { 
            background: none; border: none; font-size: 11px; font-weight: 700; 
            cursor: pointer; color: var(--text-dark); letter-spacing: 0.5px; 
            min-width: 60px; z-index: 2; padding: 10px 0;
        }
        .text-btn.left { text-align: left; }
        .text-btn.right { text-align: right; color: var(--app-green); }

        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }

        /* Grid Styles */
        .skin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .skin-card {
            background: var(--app-bg); border: 1px solid var(--border);
            padding: 16px 8px; display: flex; flex-direction: column;
            align-items: center; cursor: pointer; position: relative;
            transition: background 0.2s; height: 180px; justify-content: center;
        }
        .skin-card:active { background: var(--app-gray); }
        .skin-card-name { font-size: 12px; font-weight: 700; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; margin-top: 10px; }
        .order-tag { font-size: 9px; color: var(--app-green); font-weight: 800; margin-bottom: 8px; letter-spacing: 1px; }

        .preview-row {
            display: flex; gap: 8px; justify-content: center;
            background: #f9f9f9; padding: 8px; border-radius: 8px;
        }
        .skin-canvas { width: 48px; height: 96px; image-rendering: pixelated; }

        #bottomSheetOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100; display: none; opacity: 0; transition: opacity 0.3s;
        }
        #bottomSheet {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 85vh;
            max-height: 85%;
            background: white; border-radius: 24px 24px 0 0;
            z-index: 101; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            will-change: transform;
        }
        #bottomSheet.active { transform: translateY(0); }
        
        .sheet-handle-area { width: 100%; padding: 20px 0; cursor: grab; flex-shrink: 0; touch-action: none; }
        .sheet-handle { width: 40px; height: 5px; background: #ddd; border-radius: 10px; margin: 0 auto; }
        .sheet-content { flex: 1; overflow-y: auto; padding: 0 24px 40px; }

        details {
            background: #f9f9f9; border-radius: 8px; padding: 12px;
            margin-bottom: 24px; border: 1px solid var(--border);
        }
        summary {
            font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-dark);
            cursor: pointer; outline: none; list-style: none; display: flex; justify-content: space-between; align-items: center;
        }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; font-size: 16px; font-weight: bold; }
        details[open] summary::after { content: '-'; }
        
        .adv-group { margin-top: 16px; }
        .adv-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .adv-row label { margin: 0; font-size: 11px; font-weight: 600; }
        .adv-row input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--app-green); }

        .anim-list-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; width: 100%; }
        .anim-row-item { display: flex; gap: 6px; align-items: center; width: 100%; box-sizing: border-box; }
        .anim-input { flex: 1; min-width: 0; width: 0; font-family: monospace; font-size: 11px; padding: 10px !important; }
        .btn-add-anim { width: 100%; background: #fff; border: 1px dashed #aaa; padding: 10px; color: #555; font-size: 11px; font-weight: bold; cursor: pointer; border-radius: 0; }
        .btn-del-anim { width: 28px; height: 36px; background: var(--danger); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; flex-shrink: 0; }

        #viewer3D {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 200; display: none; flex-direction: column;
        }
        #canvas3D { width: 100%; flex: 1; cursor: grab; touch-action: none; }
        #canvas3D:active { cursor: grabbing; }

        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; font-size: 10px; color: var(--text-light); margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }
        .form-group input, .form-group select {
            width: 100%; padding: 14px; border: 1px solid var(--border);
            background: var(--app-bg); font-size: 14px; outline: none; border-radius: 0;
        }

        /* Custom Segment Control (Toggle Button) */
        .segment-control {
            display: flex;
            background: #f4f4f4;
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .segment-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-light);
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }
        .segment-btn.active {
            background: white;
            color: var(--text-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 16px 20px; background: white; border-top: 1px solid var(--border);
            display: flex; gap: 10px; z-index: 5;
        }
        .btn-full { flex: 1; padding: 16px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; border-radius: 0; display: flex; align-items: center; justify-content: center; }
        .btn-green { background: var(--app-green); color: white; }
        .btn-black { background: #111; color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; color: var(--text-dark); margin-top: 8px; }

        .summary-list { 
            background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 20px; 
            max-height: 50vh; overflow-y: auto; border: 1px solid var(--border);
        }
        .summary-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #eee; font-size: 12px;
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-name { font-weight: bold; }
        .summary-id { color: #888; font-size: 10px; }

        /* Custom Dialog UI */
        .dialog-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.2s; backdrop-filter: blur(2px);
        }
        .dialog-overlay.active { opacity: 1; }
        .dialog-box {
            background: white; width: 80%; max-width: 320px;
            padding: 24px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.2s cubic-bezier(0.2,0.8,0.2,1);
            text-align: center;
        }
        .dialog-overlay.active .dialog-box { transform: scale(1); }
        .dialog-title { font-size: 16px; font-weight: 800; margin-bottom: 12px; text-transform: uppercase; }
        .dialog-msg { font-size: 13px; color: #555; margin-bottom: 24px; line-height: 1.5; white-space: pre-wrap; }
        .dialog-actions { display: flex; gap: 10px; }
        .dialog-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase;
        }
        .dialog-btn-cancel { background: #f0f0f0; color: #555; }
        .dialog-btn-confirm { background: var(--app-green); color: white; }
        .dialog-btn-danger { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <div id="customDialog" class="dialog-overlay">
        <div class="dialog-box">
            <div class="dialog-title" id="dialogTitle">TITLE</div>
            <div class="dialog-msg" id="dialogMsg">Message</div>
            <div class="dialog-actions">
                <button class="dialog-btn dialog-btn-cancel" onclick="closeCustomDialog(false)">Cancel</button>
                <button class="dialog-btn dialog-btn-confirm" id="dialogConfirmBtn" onclick="closeCustomDialog(true)">Confirm</button>
            </div>
        </div>
    </div>

    <div id="startScreen" class="screen active" style="justify-content:center; align-items:center; background:#111; color:white;">
        <div style="font-size:24px; font-weight:900; letter-spacing:4px; margin-bottom:40px;">SKINPACK STUDIO</div>
        <button class="btn-green" style="padding:18px 48px;" onclick="openWizard()">NEW PROJECT</button>
    </div>

    <div id="setupScreen" class="screen">
        <div class="app-bar">
            <button class="text-btn left" onclick="handleSetupBack()">BACK</button>
            <h2>PROJECT INFO</h2>
            <div class="text-btn right"></div>
        </div>
        <div class="content">
            <div class="form-group"><label>Pack Name</label><input type="text" id="packName"></div>
            <div class="form-group"><label>Localization Name (Required, No Spaces)</label><input type="text" id="localizationName" placeholder="e.g. my_pack" oninput="handleSetupInput(this)"></div>
            <div class="form-group"><label>Serialize ID (Required, No Spaces)</label><input type="text" id="serializeName" oninput="handleSetupInput(this)"></div>
        </div>
        <div class="bottom-bar">
            <button id="confirmBtn" class="btn-full btn-green" onclick="completeSetup()">CONFIRM</button>
        </div>
    </div>

    <div id="mainScreen" class="screen">
        <div class="app-bar">
            <button class="text-btn left" onclick="openSettings()">INFO</button>
            <h2 id="mainPackTitle">SKIN LIST</h2>
            <button class="text-btn right" onclick="checkAndExport()">EXPORT</button>
        </div>
        <div class="content"><div class="skin-grid" id="skinGrid"></div></div>
        
        <div class="bottom-bar">
            <label for="fileAdd" class="btn-full btn-black" style="cursor:pointer;">+ ADD SKIN</label>
            <button class="btn-full btn-green" onclick="checkAndExport()">SAVE MCPACK</button>
        </div>
        
        <input type="file" id="fileAdd" accept=".png, .tga, image/png, image/x-tga, image/targa" multiple style="display:none" onchange="handleAddFiles(this)">
    </div>

    <div id="exportScreen" class="screen">
        <div class="app-bar">
            <button class="text-btn left" onclick="navTo('mainScreen')">CANCEL</button>
            <h2>SUMMARY</h2>
            <div class="text-btn right"></div>
        </div>
        <div class="content">
            <div style="margin-bottom:12px; font-size:12px; color:#666; text-transform:uppercase; font-weight:bold;">Skins to be exported:</div>
            <div id="exportSummaryList" class="summary-list"></div>
            <div style="font-size:11px; color:#888; text-align:center;">
                Please verify all skin names and settings before downloading.
            </div>
        </div>
        <div class="bottom-bar">
            <button class="btn-full btn-green" onclick="finalDownload()">DOWNLOAD .MCPACK</button>
        </div>
    </div>

    <div id="bottomSheetOverlay" onclick="closeSheet()"></div>
    <div id="bottomSheet">
        <div class="sheet-handle-area" id="sheetHandle">
            <div class="sheet-handle"></div>
        </div>
        <div class="sheet-content">
            <h3 style="font-size:16px; font-weight:800; margin-bottom:24px; text-transform:uppercase;">Edit Skin</h3>
            <div id="sheetForm"></div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-full btn-black" style="flex:1;" onclick="start3DPreview()">3D PREVIEW</button>
            </div>
            
            <button class="btn-full btn-outline" style="margin-top:10px; width:100%; border:1px solid #ccc; background:#f4f4f4;" onclick="duplicateCurrentSkin()">DUPLICATE SKIN</button>

            <button style="width:100%; background:none; border:none; color:#ff3b30; font-weight:700; margin-top:30px; font-size:12px; text-transform:uppercase;" onclick="deleteCurrentSkin()">Remove Skin</button>
        </div>
    </div>

    <div id="viewer3D">
        <div class="app-bar" style="background:#111; color:white; border-bottom:1px solid #333;">
            <div class="text-btn left"></div>
            <h2>PREVIEW</h2>
            <button class="text-btn right" style="color:white;" onclick="close3DViewer()">CLOSE</button>
        </div>
        <div id="canvas3D"></div>
        <div style="padding:20px; color:#666; font-size:10px; text-align:center; text-transform:uppercase;">Touch & Drag to Rotate</div>
    </div>

    <script>
        let lastWidth = window.innerWidth;
        function setAppHeight() { document.documentElement.style.setProperty('--vh', `${window.innerHeight}px`); }
        setAppHeight(); window.addEventListener('resize', () => { if (window.innerWidth !== lastWidth) { lastWidth = window.innerWidth; setAppHeight(); } });

        // [추가됨] 새로고침/닫기 방지 복구
        window.onbeforeunload = function() {
            if (isProjectActive) return "Unsaved changes will be lost.";
        };

        // --- CUSTOM DIALOG ---
        let dialogResolver = null;
        function showCustomConfirm(title, msg, isDanger = false) {
            return new Promise(resolve => {
                document.getElementById('dialogTitle').innerText = title;
                document.getElementById('dialogMsg').innerText = msg;
                const btn = document.getElementById('dialogConfirmBtn');
                if(isDanger) { btn.className='dialog-btn dialog-btn-danger'; btn.innerText="DELETE"; }
                else { btn.className='dialog-btn dialog-btn-confirm'; btn.innerText="CONFIRM"; }
                const overlay = document.getElementById('customDialog');
                overlay.style.display = 'flex'; setTimeout(() => overlay.classList.add('active'), 10);
                dialogResolver = resolve;
            });
        }
        function showCustomAlert(title, msg) {
            return new Promise(resolve => {
                document.getElementById('dialogTitle').innerText = title;
                document.getElementById('dialogMsg').innerText = msg;
                const btn = document.getElementById('dialogConfirmBtn');
                btn.className = 'dialog-btn dialog-btn-confirm'; btn.innerText = "OK";
                document.querySelector('.dialog-btn-cancel').style.display = 'none';
                const overlay = document.getElementById('customDialog');
                overlay.style.display = 'flex'; setTimeout(() => overlay.classList.add('active'), 10);
                dialogResolver = (val) => { document.querySelector('.dialog-btn-cancel').style.display = 'block'; resolve(val); };
            });
        }
        function closeCustomDialog(result) {
            const overlay = document.getElementById('customDialog');
            overlay.classList.remove('active');
            setTimeout(() => { overlay.style.display = 'none'; if (dialogResolver) dialogResolver(result); dialogResolver = null; }, 200);
        }

        // --- DATA ---
        let projectData = { packName: "My Pack", localizationName: "my_pack", serializeName: "my_pack" };
        let skins = [];
        let selectedIndex = -1;
        let skinFiles = new Map();
        let isProjectActive = false;

        // --- VALIDATION & UTILS ---
        function validateNoSpace(input) {
            const hasSpace = /\s/.test(input.value);
            if (hasSpace) input.classList.add('input-error'); else input.classList.remove('input-error');
            return !hasSpace;
        }
        function validateMandatory(input) {
            const val = input.value;
            const isInvalid = val.trim() === "" || /\s/.test(val);
            if (isInvalid) input.classList.add('input-error'); 
            else input.classList.remove('input-error');
            return !isInvalid;
        }
        function handleSetupInput(input) { validateMandatory(input); checkSetupButton(); }
        function checkSetupButton() {
            const locInput = document.getElementById('localizationName');
            const serInput = document.getElementById('serializeName');
            const locInvalid = locInput.value.trim() === "" || /\s/.test(locInput.value);
            const serInvalid = serInput.value.trim() === "" || /\s/.test(serInput.value);
            document.getElementById('confirmBtn').disabled = locInvalid || serInvalid;
        }
        function getSafeFileName(name) {
            return name.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_.-]/g, '');
        }

        // --- NAV ---
        function navTo(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function openWizard() {
            const loc = document.getElementById('localizationName');
            const ser = document.getElementById('serializeName');
            document.getElementById('packName').value = projectData.packName;
            loc.value = projectData.localizationName;
            ser.value = projectData.serializeName;
            loc.classList.remove('input-error'); ser.classList.remove('input-error');
            navTo('setupScreen'); checkSetupButton();
        }
        function openSettings() { openWizard(); }
        async function handleSetupBack() { 
            if (isProjectActive) navTo('mainScreen'); 
            else if(await showCustomConfirm("EXIT WIZARD", "Go back to start screen?\nUnsaved changes will be lost.")) navTo('startScreen'); 
        }
        function completeSetup() {
            projectData.packName = document.getElementById('packName').value;
            projectData.localizationName = document.getElementById('localizationName').value;
            projectData.serializeName = document.getElementById('serializeName').value;
            document.getElementById('mainPackTitle').innerText = projectData.packName;
            isProjectActive = true; navTo('mainScreen');
        }

        // --- FILES ---
        async function handleAddFiles(input) {
            const files = Array.from(input.files); let hasInvalidFile = false;
            files.forEach(file => {
                const lower = file.name.toLowerCase();
                if (!lower.endsWith('.png') && !lower.endsWith('.tga')) { hasInvalidFile = true; return; }
                
                let baseName = file.name.replace(/\.[^/.]+$/, "");
                let safeName = getSafeFileName(baseName);
                let fileName = safeName + ".png";

                let counter = 1;
                while (skinFiles.has(fileName)) {
                    fileName = `${safeName}_${counter}.png`;
                    counter++;
                }

                skins.push({ 
                    localization_name: safeName, displayName: baseName, 
                    geometry: 'geometry.humanoid.custom', texture: fileName, skinType: 'normal',
                    enable_attachables: true,
                    animations: [] 
                });
                skinFiles.set(fileName, file);
            });
            if (hasInvalidFile) await showCustomAlert("INVALID FILES", "Some files were skipped.\nOnly .png and .tga are allowed.");
            renderGrid(); input.value = '';
            if (skins.length > 0 && !hasInvalidFile) openSkinSettings(skins.length - 1);
        }

        // --- GRID ---
        function renderGrid() {
            const grid = document.getElementById('skinGrid');
            grid.innerHTML = ''; 
            skins.forEach((s, i) => {
                grid.innerHTML += `
                <div class="skin-card" onclick="openSkinSettings(${i})">
                    <div class="order-tag">ITEM ${i+1}</div>
                    <div class="preview-row">
                        <canvas id="preview_f_${i}" width="16" height="32" class="skin-canvas"></canvas>
                        <canvas id="preview_b_${i}" width="16" height="32" class="skin-canvas"></canvas>
                    </div>
                    <div class="skin-card-name">${s.displayName}</div>
                </div>`;
            });
            skins.forEach((s, i) => updateSkinCanvas(i));
        }
        function updateSkinCanvas(index) {
            const s = skins[index]; const f = skinFiles.get(s.texture); if (!f) return;
            const img = new Image(); img.src = URL.createObjectURL(f);
            img.onload = () => { const slim = s.skinType==='slim'; drawPaperDoll(img, document.getElementById(`preview_f_${index}`), false, slim); drawPaperDoll(img, document.getElementById(`preview_b_${index}`), true, slim); };
        }
        function drawPaperDoll(img, canvas, isBack, isSlim) {
            if(!canvas) return; const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,16,32);
            const d = (sx,sy,w,h,dx,dy,dw,dh) => ctx.drawImage(img,sx,sy,w,h,dx,dy,dw,dh);
            const aw = isSlim?3:4;
            if(!isBack) {
                d(8,8,8,8,4,0,8,8); d(40,8,8,8,4,0,8,8); d(20,20,8,12,4,8,8,12); d(20,36,8,12,4,8,8,12);
                d(44,20,aw,12,4-aw,8,aw,12); d(44,36,aw,12,4-aw,8,aw,12); d(36,52,aw,12,12,8,aw,12); d(52,52,aw,12,12,8,aw,12);
                d(4,20,4,12,4,20,4,12); d(4,36,4,12,4,20,4,12); d(20,52,4,12,8,20,4,12); d(4,52,4,12,8,20,4,12);
            } else {
                d(24,8,8,8,4,0,8,8); d(56,8,8,8,4,0,8,8); d(32,20,8,12,4,8,8,12); d(32,36,8,12,4,8,8,12);
                const rx = isSlim?51:52; d(rx,20,aw,12,12,8,aw,12); d(rx,36,aw,12,12,8,aw,12);
                const lx = isSlim?43:44; const ls = isSlim?59:60; d(lx,52,aw,12,4-aw,8,aw,12); d(ls,52,aw,12,4-aw,8,aw,12);
                d(12,20,4,12,8,20,4,12); d(12,36,4,12,8,20,4,12); d(28,52,4,12,4,20,4,12); d(12,52,4,12,4,20,4,12);
            }
        }

        // --- BOTTOM SHEET ---
        const sheet = document.getElementById('bottomSheet');
        const handle = document.getElementById('sheetHandle');
        let startY = 0, currentY = 0, isDragging = false, lastY = 0, lastTime = 0, velocity = 0;
        handle.addEventListener('touchstart', e => { startY = e.touches[0].clientY; lastY = startY; lastTime = Date.now(); velocity = 0; isDragging = true; sheet.style.transition = 'none'; }, {passive: false});
        document.addEventListener('touchmove', e => { if (!isDragging) return; const cy = e.touches[0].clientY; const dt = Date.now() - lastTime; if (dt > 0) velocity = (cy - lastY) / dt; lastY = cy; lastTime = Date.now(); const delta = cy - startY; if (delta > 0) { e.preventDefault(); currentY = delta; sheet.style.transform = `translateY(${currentY}px)`; } }, {passive: false});
        document.addEventListener('touchend', () => { if (!isDragging) return; isDragging = false; sheet.style.transition = 'transform 0.3s cubic-bezier(0.25, 1, 0.5, 1)'; if (currentY > 150 || velocity > 0.5) { sheet.style.transform = `translateY(100%)`; document.getElementById('bottomSheetOverlay').style.opacity = '0'; setTimeout(() => { closeSheet(true); }, 300); } else { sheet.style.transform = `translateY(0)`; } currentY = 0; velocity = 0; });

        function closeSheet(skipAnimation = false) {
            const overlay = document.getElementById('bottomSheetOverlay');
            if (!skipAnimation) {
                sheet.classList.remove('active');
                sheet.style.transform = '';
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            } else {
                sheet.classList.remove('active');
                sheet.style.transform = '';
                overlay.style.display = 'none';
            }
        }

        // --- SHEET CONTENTS ---
        function openSkinSettings(i) {
            selectedIndex = i;
            const s = skins[i];
            sheet.style.transform = ''; 
            
            document.getElementById('sheetForm').innerHTML = `
                <div class="form-group"><label>Display Name</label><input type="text" value="${s.displayName}" oninput="handleDisplayNameChange(this.value, ${i})"></div>
                <div class="form-group"><label>ID (No Spaces)</label><input type="text" value="${s.localization_name}" oninput="handleLocIdChange(this, ${i})"></div>
                <div class="form-group"><label>Texture File Name</label><input type="text" value="${s.texture}" onchange="updateFileName(this.value, ${i})"></div>
                
                <div class="form-group">
                    <label>Model Type</label>
                    <div class="segment-control">
                        <button class="segment-btn ${s.skinType==='normal'?'active':''}" onclick="handleTypeChange('normal', ${i}, this)">Normal (Steve)</button>
                        <button class="segment-btn ${s.skinType==='slim'?'active':''}" onclick="handleTypeChange('slim', ${i}, this)">Slim (Alex)</button>
                    </div>
                </div>
                
                <details>
                    <summary>Advanced Settings</summary>
                    <div class="adv-group">
                        <div class="adv-row">
                            <label>Enable Armor/Elytra</label>
                            <input type="checkbox" ${s.enable_attachables ? 'checked' : ''} onchange="skins[${i}].enable_attachables = this.checked">
                        </div>
                        <div class="form-group" style="margin-bottom:8px;">
                            <label>Animations (Key : Value)</label>
                        </div>
                        <div id="animListContainer" class="anim-list-container"></div>
                        <button class="btn-add-anim" onclick="addAnimRow(${i})">+ ADD ANIMATION</button>
                    </div>
                </details>
            `;
            
            renderAnimRows(i);
            document.getElementById('bottomSheetOverlay').style.display = 'block';
            setTimeout(() => { document.getElementById('bottomSheetOverlay').style.opacity = '1'; sheet.classList.add('active'); }, 10);
        }

        function renderAnimRows(skinIndex) {
            const container = document.getElementById('animListContainer');
            if (!container) return;
            const currentAnims = skins[skinIndex].animations || [];
            let html = '';
            currentAnims.forEach((anim, animIndex) => {
                html += `
                <div class="anim-row-item">
                    <input class="anim-input" placeholder="Key (e.g. holding)" value="${anim.key || ''}" oninput="updateAnimData(${skinIndex}, ${animIndex}, 'key', this.value)">
                    <span style="font-weight:bold">:</span>
                    <input class="anim-input" placeholder="Value (e.g. anim.idle)" value="${anim.value || ''}" oninput="updateAnimData(${skinIndex}, ${animIndex}, 'value', this.value)">
                    <button class="btn-del-anim" onclick="removeAnimRow(${skinIndex}, ${animIndex})">X</button>
                </div>`;
            });
            container.innerHTML = html;
        }

        function addAnimRow(skinIndex) {
            if (!skins[skinIndex].animations) skins[skinIndex].animations = [];
            skins[skinIndex].animations.push({ key: "", value: "" });
            renderAnimRows(skinIndex);
        }

        async function removeAnimRow(skinIndex, animIndex) {
            if (await showCustomConfirm("DELETE ANIMATION", "Remove this animation line?", true)) {
                skins[skinIndex].animations.splice(animIndex, 1);
                renderAnimRows(skinIndex);
            }
        }

        function updateAnimData(skinIndex, animIndex, field, val) {
            skins[skinIndex].animations[animIndex][field] = val;
        }

        function handleDisplayNameChange(val, i) { skins[i].displayName = val; const card = document.querySelectorAll('.skin-card-name')[i]; if(card) card.innerText = val; }
        function handleLocIdChange(input, i) { validateMandatory(input); skins[i].localization_name = input.value; }
        
        function handleTypeChange(val, i, btnElement) { 
            skins[i].skinType = val; 
            skins[i].geometry = (val==='slim'?'geometry.humanoid.customSlim':'geometry.humanoid.custom'); 
            const parent = btnElement.parentElement;
            parent.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            updateSkinCanvas(i); 
        }
        
        function updateFileName(val, i) {
            val = val.trim();
            if (!val) return; 

            if (!val.toLowerCase().endsWith('.png')) { val += '.png'; }
            let base = val.replace(/\.png$/i, '');
            val = getSafeFileName(base) + ".png";

            const oldTextureName = skins[i].texture;
            if (val === oldTextureName) return;

            if (skinFiles.has(val)) { 
                showCustomAlert("ERROR", "File name already exists."); 
                const inputs = document.querySelectorAll('#sheetForm input');
                if(inputs[2]) inputs[2].value = oldTextureName;
                return; 
            }

            if (skinFiles.has(oldTextureName)) { 
                const f = skinFiles.get(oldTextureName); 
                skinFiles.delete(oldTextureName); 
                skinFiles.set(val, f); 
            }
            
            skins[i].texture = val;
            const inputs = document.querySelectorAll('#sheetForm input');
            if(inputs[2]) inputs[2].value = val;
        }

        function duplicateCurrentSkin() {
            const src = skins[selectedIndex];
            const newName = src.displayName + " Copy";
            const newId = src.localization_name + "_copy";
            const newSkin = JSON.parse(JSON.stringify(src));
            newSkin.displayName = newName;
            newSkin.localization_name = newId;
            skins.push(newSkin);
            closeSheet();
            renderGrid();
        }

        async function deleteCurrentSkin() { 
            if(await showCustomConfirm("DELETE SKIN", "Are you sure you want to delete this skin?", true)) {
                const textureName = skins[selectedIndex].texture;
                skins.splice(selectedIndex, 1);
                const isTextureUsed = skins.some(s => s.texture === textureName);
                if (!isTextureUsed && skinFiles.has(textureName)) { skinFiles.delete(textureName); }
                closeSheet(); 
                renderGrid(); 
            }
        }

        // --- 3D VIEWER ---
        let scene, camera, renderer, modelGroup; let is3DInit = false;
        function start3DPreview() { document.getElementById('viewer3D').style.display = 'flex'; if (is3DInit && modelGroup) clearModelGroup(); setTimeout(() => { if (!is3DInit) { init3D(); is3DInit = true; } else { updateViewerSize(); } loadSkinModel(skins[selectedIndex]); }, 10); }
        function close3DViewer() { document.getElementById('viewer3D').style.display = 'none'; }
        function updateViewerSize() { const container = document.getElementById('canvas3D'); if (renderer && container) { const w = container.clientWidth; const h = container.clientHeight; renderer.setSize(w, h); camera.aspect = w / h; camera.updateProjectionMatrix(); } }
        function clearModelGroup() { if (!modelGroup) return; while(modelGroup.children.length > 0){ const child = modelGroup.children[0]; if(child.geometry) child.geometry.dispose(); if(child.material) { if(Array.isArray(child.material)) child.material.forEach(m => m.dispose()); else child.material.dispose(); } modelGroup.remove(child); } }
        function init3D() { const container = document.getElementById('canvas3D'); scene = new THREE.Scene(); camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100); camera.position.z = 40; renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(container.clientWidth, container.clientHeight); renderer.setPixelRatio(window.devicePixelRatio); renderer.outputEncoding = THREE.sRGBEncoding; container.appendChild(renderer.domElement); scene.add(new THREE.AmbientLight(0xffffff, 1.2)); modelGroup = new THREE.Group(); scene.add(modelGroup); let isDown = false, startX = 0, startY = 0; container.addEventListener('pointerdown', e => { isDown = true; startX = e.clientX; startY = e.clientY; container.setPointerCapture(e.pointerId); }); container.addEventListener('pointermove', e => { if (!isDown) return; modelGroup.rotation.y += (e.clientX - startX) * 0.01; modelGroup.rotation.x += (e.clientY - startY) * 0.01; startX = e.clientX; startY = e.clientY; }); container.addEventListener('pointerup', e => { isDown = false; container.releasePointerCapture(e.pointerId); }); window.addEventListener('resize', updateViewerSize); function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); } animate(); }
        function loadSkinModel(skin) { clearModelGroup(); modelGroup.rotation.set(0, 0, 0); modelGroup.scale.set(0.75, 0.75, 0.75); modelGroup.position.set(0,0,0); const file = skinFiles.get(skin.texture); if (!file) return; const img = new Image(); img.src = URL.createObjectURL(file); img.onload = () => { createSteveModel(img, skin.skinType === 'slim'); modelGroup.children.forEach(child => { child.position.y -= 16; }); }; }
        function createSteveModel(img, isSlim) { const getTex = (x, y, w, h, isTransparent, isFlipped = false) => { const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.save(); if (isFlipped) { ctx.translate(0, h); ctx.scale(1, -1); } ctx.drawImage(img, x, y, w, h, 0, 0, w, h); ctx.restore(); const tex = new THREE.CanvasTexture(canvas); tex.magFilter = THREE.NearestFilter; tex.minFilter = THREE.NearestFilter; tex.encoding = THREE.sRGBEncoding; return new THREE.MeshBasicMaterial({ map: tex, color: 0xffffff, transparent: isTransparent, opacity: 1, alphaTest: isTransparent ? 0.1 : 0, side: isTransparent ? THREE.DoubleSide : THREE.FrontSide }); }; function createLimb(w, h, d, x, y, z, u, v, inflate = 0) { const boxW = w + inflate * 2; const boxH = h + inflate * 2; const boxD = d + inflate * 2; const geometry = new THREE.BoxGeometry(boxW, boxH, boxD); const isOuter = inflate > 0; const materials = [ getTex(u + d + w, v + d, d, h, isOuter), getTex(u, v + d, d, h, isOuter), getTex(u + d, v, w, d, isOuter), getTex(u + d + w, v, w, d, isOuter, true), getTex(u + d, v + d, w, h, isOuter), getTex(u + d + w + d, v + d, w, h, isOuter) ]; const mesh = new THREE.Mesh(geometry, materials); mesh.position.set(x, y, z); modelGroup.add(mesh); } createLimb(8, 8, 8, 0, 28, 0, 0, 0); createLimb(8, 8, 8, 0, 28, 0, 32, 0, 0.5); createLimb(8, 12, 4, 0, 18, 0, 16, 16); createLimb(8, 12, 4, 0, 18, 0, 16, 32, 0.25); const armW = isSlim ? 3 : 4; const armX = isSlim ? 5.5 : 6; const armY = isSlim ? 17.5 : 18; createLimb(armW, 12, 4, -armX, armY, 0, 40, 16); createLimb(armW, 12, 4, -armX, armY, 0, 40, 32, 0.25); createLimb(armW, 12, 4, armX, armY, 0, 32, 48); createLimb(armW, 12, 4, armX, armY, 0, 48, 48, 0.25); createLimb(4, 12, 4, -1.9, 6, 0, 0, 16); createLimb(4, 12, 4, -1.9, 6, 0, 0, 32, 0.25); createLimb(4, 12, 4, 1.9, 6, 0, 16, 48); createLimb(4, 12, 4, 1.9, 6, 0, 0, 48, 0.25); }

        // --- EXPORT ---
        async function checkAndExport() {
            if (skins.length === 0) { await showCustomAlert("NO SKINS", "Please add at least one skin."); return; }
            
            // [추가됨] ID 중복 검사
            const ids = skins.map(s => s.localization_name);
            const duplicateIds = ids.filter((item, index) => ids.indexOf(item) !== index);
            if (duplicateIds.length > 0) {
                await showCustomAlert("DUPLICATE ID", `Duplicate ID found: ${duplicateIds[0]}\nPlease change one of them.`);
                return;
            }

            // [추가됨] 파일 누락 검사
            const missingFiles = skins.filter(s => !skinFiles.has(s.texture));
            if (missingFiles.length > 0) {
                await showCustomAlert("MISSING FILES", `Error: Texture file not found for ${missingFiles[0].displayName}.\nPlease re-add the texture.`);
                return;
            }

            if (skins.some(s => !s.localization_name || s.localization_name.trim() === "")) { await showCustomAlert("ERROR", "Skin ID cannot be empty.\nPlease check your skins."); return; }
            if (skins.some(s => /\s/.test(s.localization_name))) { await showCustomAlert("ERROR", "Remove spaces from Skin IDs."); return; }

            const list = document.getElementById('exportSummaryList');
            list.innerHTML = '';
            skins.forEach((s, i) => {
                list.innerHTML += `
                <div class="summary-item">
                    <div>
                        <div class="summary-name">${s.displayName}</div>
                        <div class="summary-id">${s.localization_name} (${s.skinType})</div>
                    </div>
                    <div>${s.texture}</div>
                </div>`;
            });

            navTo('exportScreen');
        }

        async function finalDownload() {
            const zip = new JSZip();
            const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => (Math.random()*16|0).toString(16));
            
            zip.file('manifest.json', JSON.stringify({
                format_version: 2,
                header: { name: projectData.packName, uuid: uuid(), version: [1,0,0] },
                modules: [{ type: "skin_pack", uuid: uuid(), version: [1,0,0] }]
            }, null, 2));

            const skinsJsonData = skins.map(s => {
                let obj = {
                    localization_name: s.localization_name,
                    geometry: s.geometry,
                    texture: s.texture,
                    type: "free"
                };
                if (s.enable_attachables === false) obj.enable_attachables = false;
                if (s.animations && s.animations.length > 0) {
                    let animObj = {};
                    let hasAnim = false;
                    s.animations.forEach(a => {
                        if(a.key && a.value) { animObj[a.key] = a.value; hasAnim = true; }
                    });
                    if (hasAnim) obj.animations = animObj;
                }
                return obj;
            });

            zip.file('skins.json', JSON.stringify({
                serialize_name: projectData.serializeName,
                localization_name: projectData.localizationName,
                skins: skinsJsonData
            }, null, 2));

            let lang = `skinpack.${projectData.localizationName}=${projectData.packName}\n`;
            skins.forEach(s => {
                lang += `skin.${projectData.localizationName}.${s.localization_name}=${s.displayName}\n`;
            });
            zip.file('texts/en_US.lang', lang);

            for (const [name, file] of skinFiles) zip.file(name, file);

            const content = await zip.generateAsync({type: 'blob'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = `${projectData.packName}.mcpack`;
            a.click();
        }
    </script>
</body>
</html>
